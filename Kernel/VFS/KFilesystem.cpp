// This file is part of PadOS.
//
// Copyright (C) 2018 Kurt Skauen <http://kavionic.com/>
//
// PadOS is free software : you can redistribute it and / or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// PadOS is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with PadOS. If not, see <http://www.gnu.org/licenses/>.
///////////////////////////////////////////////////////////////////////////////
// Created: 23.02.2018 01:53:33

#include <System/Platform.h>

#include <sys/uio.h>
#include <sys/types.h>

#include <Kernel/VFS/KFilesystem.h>
#include <Kernel/VFS/KFSVolume.h>
#include <Kernel/VFS/KINode.h>
#include <Kernel/VFS/KFileHandle.h>
#include <Kernel/VFS/FileIO.h>
#include <System/System.h>
#include <System/ExceptionHandling.h>

using namespace kernel;
using namespace os;

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

PErrorCode KFilesystem::Probe(const char* devicePath, fs_info* fsInfo)
{
    return PErrorCode::NotImplemented;
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

Ptr<KFSVolume> KFilesystem::Mount(fs_id volumeID, const char* devicePath, uint32_t flags, const char* args, size_t argLength)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

void KFilesystem::Unmount(Ptr<KFSVolume> volume)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

void KFilesystem::Sync(Ptr<KFSVolume> volume)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

void KFilesystem::ReadFSStat(Ptr<KFSVolume> volume, fs_info* fsinfo)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

void KFilesystem::WriteFSStat(Ptr<KFSVolume> volume, const fs_info* fsinfo, uint32_t mask)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

Ptr<KINode> KFilesystem::LocateInode(Ptr<KFSVolume> volume, Ptr<KINode> parent, const char* path, int pathLength)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

void KFilesystem::ReleaseInode(KINode* inode)
{
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

Ptr<KFileNode> KFilesystemFileOps::OpenFile(Ptr<KFSVolume> volume, Ptr<KINode> node, int openFlags)
{
    Ptr<KFileNode> file = ptr_new<KFileNode>(openFlags);
    return file;
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

Ptr<KFileNode> KFilesystem::CreateFile(Ptr<KFSVolume> volume, Ptr<KINode> parent, const char* name, int nameLength, int openFlags, int permission)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

void KFilesystemFileOps::CloseFile(Ptr<KFSVolume> volume, KFileNode* file)
{
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

Ptr<KINode> KFilesystem::LoadInode(Ptr<KFSVolume> volume, ino_t inode)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

Ptr<KDirectoryNode> KFilesystemFileOps::OpenDirectory(Ptr<KFSVolume> volume, Ptr<KINode> node)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

void KFilesystem::CreateDirectory(Ptr<KFSVolume> volume, Ptr<KINode> parent, const char* name, int nameLength, int permission)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

void KFilesystem::Rename(Ptr<KFSVolume> volume, Ptr<KINode> oldParent, const char* oldName, int oldNameLen, Ptr<KINode> newParent, const char* newName, int newNameLen, bool mustBeDir)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////
    
void KFilesystem::Unlink(Ptr<KFSVolume> volume, Ptr<KINode> parent, const char* name, int nameLength)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

void KFilesystem::RemoveDirectory(Ptr<KFSVolume> volume, Ptr<KINode> parent, const char* name, int nameLength)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

void KFilesystemFileOps::CloseDirectory(Ptr<KFSVolume> volume, Ptr<KDirectoryNode> directory)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

size_t KFilesystemFileOps::Read(Ptr<KFileNode> file, void* buffer, size_t length, off64_t position)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

size_t KFilesystemFileOps::Write(Ptr<KFileNode> file, const void* buffer, size_t length, off64_t position)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

size_t KFilesystemFileOps::Read(Ptr<KFileNode> file, const iovec_t* segments, size_t segmentCount, off64_t position)
{
    size_t totalBytesRead = 0;
    for (size_t i = 0; i < segmentCount; ++i)
    {
        const iovec_t& segment = segments[i];

        const size_t bytesRead = Read(file, segment.iov_base, segment.iov_len, position);
        totalBytesRead += bytesRead;
        position += bytesRead;
        if (bytesRead != segment.iov_len) {
            break;
        }
    }
    return totalBytesRead;
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

size_t KFilesystemFileOps::Write(Ptr<KFileNode> file, const iovec_t* segments, size_t segmentCount, off64_t position)
{
    size_t totalBytesWritten = 0;
    for (size_t i = 0; i < segmentCount; ++i)
    {
        const iovec_t& segment = segments[i];
        size_t bytesWritten = Write(file, segment.iov_base, segment.iov_len, position);
        totalBytesWritten += bytesWritten;
        position += bytesWritten;
        if (bytesWritten != segment.iov_len) {
            break;
        }
    }
    return totalBytesWritten;
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

size_t KFilesystemFileOps::ReadLink(Ptr<KFSVolume> volume, Ptr<KINode> node, char* buffer, size_t bufferSize)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

void KFilesystemFileOps::DeviceControl(Ptr<KFileNode> file, int request, const void* inData, size_t inDataLength, void* outData, size_t outDataLength)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

size_t KFilesystemFileOps::ReadDirectory(Ptr<KFSVolume> volume, Ptr<KDirectoryNode> directory, dirent_t* entry, size_t bufSize)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

void KFilesystemFileOps::RewindDirectory(Ptr<KFSVolume> volume, Ptr<KDirectoryNode> dirNode)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

void KFilesystemFileOps::CheckAccess(Ptr<KFSVolume> volume, Ptr<KINode> node, int mode)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

void KFilesystemFileOps::ReadStat(Ptr<KFSVolume> volume, Ptr<KINode> node, struct stat* stat)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

void KFilesystemFileOps::WriteStat(Ptr<KFSVolume> volume, Ptr<KINode> node, const struct stat* stat, uint32_t mask)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

void KFilesystemFileOps::Sync(Ptr<KFileNode> file)
{
    PERROR_THROW_CODE(PErrorCode::NotImplemented);
}
