// This file is part of PadOS.
//
// Copyright (C) 2001-2020 Kurt Skauen <http://kavionic.com/>
//
// PadOS is free software : you can redistribute it and / or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// PadOS is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with PadOS. If not, see <http://www.gnu.org/licenses/>.
///////////////////////////////////////////////////////////////////////////////

#include <unistd.h>
#include <sys/fcntl.h>
#include <assert.h>
#include <limits.h>
#include <Storage/Symlink.h>
#include <Storage/FileReference.h>
#include <Storage/Path.h>


///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

PSymLink::PSymLink()
{
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

PSymLink::PSymLink(const PString& path, int openFlags) : PFSNode(path, openFlags | O_PATH | O_NOFOLLOW)
{
    if (!IsLink()) {
        errno = EINVAL;
        Close();
    }
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

PSymLink::PSymLink(const PDirectory& directory, const PString& name, int openFlags) : PFSNode(directory, name, openFlags | O_PATH | O_NOFOLLOW)
{
    if (!IsLink()) {
        errno = EINVAL;
        Close();
    }
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

PSymLink::PSymLink(const PFileReference& reference, int openFlags) : PFSNode(reference, openFlags | O_PATH | O_NOFOLLOW)
{
    if (!IsLink()) {
        errno = EINVAL;
        Close();
    }
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

PSymLink::PSymLink(const PFSNode& node) : PFSNode(node)
{
    if (!IsLink()) {
        errno = EINVAL;
        Close();
    }
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

PSymLink::PSymLink(const PSymLink& link) : PFSNode(link)
{
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

PSymLink::~PSymLink()
{
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

bool PSymLink::Open(const PString& path, int openFlags)
{
    return SetTo(PFSNode(path, openFlags | O_PATH | O_NOFOLLOW));
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

bool PSymLink::Open(const PDirectory& directory, const PString& path, int openFlags)
{
    return SetTo(PFSNode(directory, path, openFlags | O_PATH | O_NOFOLLOW));
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

bool PSymLink::Open(const PFileReference& reference, int openFlags)
{
    return SetTo(PFSNode(reference, openFlags | O_PATH | O_NOFOLLOW));
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

bool PSymLink::SetTo(const PFSNode& node)
{
    if (node.IsValid() && !node.IsLink()) {
        errno = EINVAL;
        return false;
    }
    return PFSNode::SetTo(node);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

bool PSymLink::SetTo(PFSNode&& node)
{
    if (node.IsValid() && !node.IsLink()) {
        errno = EINVAL;
        return false;
    }
    return PFSNode::SetTo(node);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

bool PSymLink::SetTo(const PSymLink& link)
{
    return PFSNode::SetTo(link);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

bool PSymLink::ReadLink(PString& buffer)
{
    return false;
//    PString cBuffer;
//
//    cBuffer.resize(PATH_MAX);
//    for (;;) {
//        ssize_t nLen = freadlink(GetFileDescriptor(), cBuffer.begin(), cBuffer.size());
//        if (nLen == ssize_t(cBuffer.size())) {
//            cBuffer.resize(cBuffer.size() * 2);
//        }
//        else if (nLen < 0) {
//            return(-1);
//        }
//        else {
//            cBuffer.resize(nLen);
//            break;
//        }
//    }
//    *pcBuffer = cBuffer;
//    return(0);
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

PString PSymLink::ReadLink()
{
    PString buffer;
    if (ReadLink(buffer)) {
        return buffer;
    } else {
        return PString::zero;
    }
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

bool PSymLink::ConstructPath(const PString& parent, PPath& outPath)
{
    PString buffer;
    if (!ReadLink(buffer)) {
        return false;
    }
    if (buffer[0] == '/') {
        outPath = buffer.c_str();
    } else {
        outPath = parent;
        outPath.Append(buffer);
    }
    return true;
}

///////////////////////////////////////////////////////////////////////////////
/// \author Kurt Skauen
///////////////////////////////////////////////////////////////////////////////

bool PSymLink::ConstructPath(const PDirectory& parent, PPath& outPath)
{
    PString parentPath;
    if (!parent.GetPath(parentPath)) {
        return false;
    }
    return ConstructPath(parentPath, outPath);
}

